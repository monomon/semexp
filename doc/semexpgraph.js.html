<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: semexpgraph.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: semexpgraph.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>(function (semexp) {
	'use strict';

	/**
	 * Graph drawing and interaction module
	 * Draws the semantic graph in svg. Handles mouse interactions
	 * with the graph.
	 * @class semexp.graph
	 */
	semexp.graph = {
		radiusBase : 40,
		radiusMultiplier : 15,
		linkStrength : 0.7,
		distance : 200,
		friction : 0.9,
		charge : -500,
		gravity : 0.02,
		theta : 0.9,
		alpha : 0.7,


		/**
		 * radius calc function - depends on number of relations
		 * @todo: make this configurable somehow...
		 * @param {Object} d The data object
		 * @return {Number}
		 */
		getRadius : function(d)
		{
			return Math.round(Math.log(d.relations+1)*15 + 40);
		},

		/**
		 * Draw all nodes of the graph
		 * This also performs the data binding
		 * @param {Array} nodes
		 * @param {SVGElement} layer The SVG root element
		 * @param {Function} a drag callback
		 */
		drawNodes : function(nodes, layer, dragFunc)
		{
			layer.selectAll('.node').remove();
			var node = layer.selectAll('.node').data(nodes);
			
			var group = node.enter()
				.append('g')
				.call(dragFunc)
				.classed('node', true);

			group.append('circle')
				.attr('r', this.getRadius);

			group.append('text')
				.text(function(d) { return d.name; })
				.attr('text-anchor', 'middle')
				.attr('alignment-baseline', 'central');

			group.append('title')
			  .text(function(d) { return d.name; });

			node.select('circle')
				.attr('r', this.getRadius);

			node.exit().remove();

			this.hookHandler(node, 'mouseenter');
			this.hookHandler(node, 'mouseleave');

			// return update selection
			return node;
		},

		/**
		 * Draw all links in the graph
		 * @param {Array} links
		 * @param {SVGElement} layer The SVG root element
		 * @return {Element} the update selection for links
		 */
		drawLinks : function(links, layer)
		{
			layer.selectAll('.link').remove();
			var link = layer.selectAll('.link').data(links);

			var g = link.enter()
				.append('g')
				.classed('link', true);

			g.append('line')
				.attr('marker-end', 'url(#Triangle)');
			var label = g.append('g')
				.classed('label', true);

			var text = label
				.append('text')
				.text(function (d) {
					return d.name;
				})
				.attr('text-anchor', 'middle')
				.attr('alignment-baseline', 'central');

			if (text.node()) {
				// add background box
				var bbox = text.node().getBBox();
				var padding = 10;
				label.insert('rect', 'text')
					.attr('width',bbox.width+padding)
					.attr('height', bbox.height+padding)
					.attr('x',-(bbox.width+padding)*0.5)
					.attr('y',-(bbox.height+padding)*0.5-5)
					.attr('rx', 8)
					.attr('ry', 8);
			}

			link.exit().remove();

			// return update selection
			return link;
		},

		/**
		 * Connect mouse listeners for the nodes
		 * @param {Element} subject The element to add the listener to
		 * @param {String} eventName
		 * @return {Function} the event handler
		 */
		hookHandler : function(subject, eventName)
		{
			var explorer = this.explorer;
			var eventSwitch = {
				mouseenter : function (dat)
				{
					d3.event.preventDefault();

					// clear active classes
					d3.selectAll('.node')
						.classed('active', false);

					explorer.tools.setData('fromNode', dat);

					this.classList.add('active');

				},
				mouseout : function ()
				{
					// 	// .datum({'fromNode' : undefined})
					// 	.transition().style('opacity', 0);
				}
			};

			return subject.on(eventName, eventSwitch[eventName]);
		},

		/**
		 * Draw the graph
		 * @param {Object} graph A graph object as returned from the model
		 * @param {Element} svg The svg base element
		 * @param {Array} tickComponents
		 */
		draw : function(graph, svg, tickComponents)
		{
			this.force = d3.layout.force()
				.linkStrength(this.linkStrength)
				.distance(this.distance)
				.friction(this.friction)
				.charge(this.charge)
				.gravity(this.gravity)
				.theta(this.theta)
				.alpha(this.alpha)
				.size([svg.property('width').baseVal.value, svg.property('height').baseVal.value]);

			var defs = svg.append('defs');
			defs.append('marker')
				.attr('id', 'Triangle')
				.attr('orient', 'auto')
				.attr('refX', 7)
				.attr('refY', 2)
				.attr('markerUnits', 'strokeWidth')
				.attr('markerWidth', 10)
				.attr('markerHeight', 10)
				.append('path')
				.attr('fill', '#999933')
				.attr('d', 'M 0 0 L 3 2 L 0 4 z');

			this.layers = {
				links : svg.append('g').classed('links', true),
				nodes : svg.append('g').classed('nodes', true)
			};

			this.refresh(graph, tickComponents);
		},

		/**
		 * @todo: find out how to add nodes and links wihtout rebinding to force, etc.
		 * @param {Object} graph
		 * @param {Array} tickComponents Components to be notified of updates
		 */
		refresh : function(graph, tickComponents)
		{
			var link = this.drawLinks(graph.links, this.layers.links);
			var node = this.drawNodes(graph.nodes, this.layers.nodes, this.force.drag);
			this.force
				.links(graph.links)
				.nodes(graph.nodes)
				.start();

			// update links and nodes with force
			this.force.on('tick', function () {
				link.select('line')
					.attr('x1', function (d) { return d.source.x; })
					.attr('y1', function (d) { return d.source.y; })
					.attr('x2', function (d) { return d.target.x; })
					.attr('y2', function (d) { return d.target.y; });

				link.select('.label')
					.attr('transform', function(d) {
						return 'translate('+
						(d.source.x+d.target.x)/2+
						','+
						(d.source.y+d.target.y)/2+
						')';
					 });
				node.attr('transform', function(d) {
					return ('translate('+d.x+','+d.y+')');
				});

				// components registered and they have an udpate method
				tickComponents.forEach(function (item) {
					item.update.call(item);
				});
			});
		},

		/**
		 * Disable interaction with the nodes - remove all input listeners
		 */
		paralyzeNodes : function()
		{
			d3.selectAll('.node')
				.on('mouseenter', null)
				.on('mouseout', null);
		},

		/**
		 * Reactivate interaction with the nodes
		 * by hooking listeners again
		 */
		activateNodes : function()
		{
			this.hookHandler(d3.selectAll('.node'), 'mouseenter');
			this.hookHandler(d3.selectAll('.node'), 'mouseout');
		},

		/**
		 * Clear graph - remove all nodes and links
		 */
		clear : function()
		{
			d3.selectAll('.node').remove();
			d3.selectAll('.link').remove();
		}
	};

	return semexp;
}(window.semexp || {}));</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="semexp.html">semexp</a></li><li><a href="semexp.graph.html">graph</a></li><li><a href="semexp.menu.html">menu</a></li><li><a href="semexp.model.html">model</a></li><li><a href="semexp.tools.html">tools</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Thu May 14 2015 13:21:54 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
